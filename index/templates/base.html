<!DOCTYPE html>
{% load base_tags %}
{% load cart_tags %}
{% load static %}
{% load i18n %}
{% load sass_tags %}

<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="shortcut icon" type="image/png" href="{% static 'favicon.ico' %}"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>
    <!--    JQUERY-->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>

    <!--    POPPER-->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <!--    FONT AWESOME-->
    <link href="{% static 'fontawesome-5.13.0/css/all.css' %}" rel='stylesheet'/>
    <!--    BASE STYLE-->
    <link rel="stylesheet" href="{% static 'css/base.css' %}"/>
    <!--    BOOTSTRAP-->
    <link href="{% sass_src 'scss/base.scss' %}" rel="stylesheet" type="text/css" />
    <!--    BOOTSTRAP JS (LOAD AT END IMPORTANT)-->
    <script src="{% static 'bootstrap-4.4.1/js/bootstrap.min.js' %}"></script>
    <!--    SWEET ALERT 2-->
    <script src="{% static 'sweetalert2-9.10.12/sweetalert2.all.min.js' %}"></script>
    <!--    GOOGLE FONTS LOBSTER-->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
    {% block styles %}
    {% endblock %}
</head>
<body>
    <nav class="navbar navbar-expand-sm navbar-light bg-light">
        <a class="navbar-brand py-0" href="#">
            <img src="{% static 'images/test/logo2.png'%}" width="200" height="50" alt="">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse flex-grow-1 text-right" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto flex-nowrap">
<!--                <li class="nav-item {% if page == 'home' %} active {% endif %}">-->
<!--                    <a class="nav-link" href="#">{% trans 'Home' %}</a>-->
<!--                </li>-->
<!--                <li class="nav-item {% if page == 'login' %} active {% endif %}">-->
<!--                    {% if user.is_authenticated %}-->
<!--                        <a class="nav-link" href="#">{% trans 'Logout' %}</a>-->
<!--                    {% else %}-->
<!--                        <a class="nav-link" href="#">{% trans 'Login' %}</a>-->
<!--                    {% endif %}-->
<!--                </li>-->
                <li class="nav-item mx-1 mt-0 mt-sm-2 mt-md-1">
                    <a href="https://api.whatsapp.com/send?phone=573162128561&text=%C2%A1Hola!%20Me%20gustar%C3%ADa%20saber%20m%C3%A1s%20sobre%20Digimen%C3%BA%20Colombia%20para%20mi%20restaurante,%20ni%20nombre%20es%20"
                       type="button" class="btn px-1 btn-secondary">
                        <strong>{% trans 'Publish a menu' %}</strong>
                    </a>
                </li>
                <li>
                    <div class="btn-group-vertical btn-group-sm p-1 p-md-0 " role="group" aria-label="Basic example">
                        {% get_current_language as LANGUAGE_CODE %}
                        {% get_available_languages as LANGUAGES %}
                        {% get_language_info_list for LANGUAGES as languages %}
                        {% for language in languages %}
                            <a  href="/{{ language.code }}/{% remove_url_prefix request.path %}" type="button" class=" py-0 px-1 btn btn-sm
                             {% if language.code == LANGUAGE_CODE  %}btn-primary{%else%} btn-secondary {% endif %}"
                                title="{{language.name_local|title}}">
                                {{language.code|lower}}
                            </a>
                        {% endfor %}
                    </div>
                </li>
            </ul>
        </div>
    </nav>
    <!-- Modal -->
    <div class="modal fade" id="modalOrder" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header bg-secondary">
            <h3 class="modal-title text-primary font-weight-bold" id="modalOrderTitle">{% trans 'Your Order'%}</h3>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body px-0" id="modalBody">
            ...
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="modalAddsOn" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header bg-secondary">
            <h3 class="modal-title text-primary font-weight-bold" id="modalAddsOnTitle">{% trans 'Additions'%}</h3>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-body px-0" id="addsOnBody">
            ...
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="modalWelcome" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header bg-primary">
            <h3 class="modal-title text-white font-weight-bold" id="modalWelcomeTitle">{% trans 'Welcome to Digimen√∫' %}</h3>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class=" lead modal-body px-0" id="modalBody2">
                Pide tu comida favorita de forma facil y rapida!
          </div>
        </div>
      </div>
    </div>
        {% with total_items=cart|length %}
    <div class="container-lg">
        {% block body %}
        {% endblock %}
    </div>
    <div class="cart fixed-bottom py-1 bg-primary">
        <div class="d-flex flex-row-reverse px-1 px-md-3">
            {% if cart|length > 0 %}
                <div class="px-1">
                    <button type="button" class="btn btn-block btn-success" onClick="getOrder()">
                         <i class="fab fa-whatsapp fa-lg"></i><span class="d-sm-inline"><strong> {%trans 'Send order'%}</strong></span>
                    </button>
                </div>
            {% endif %}
            <div class="px-1 text-right">
                <button type="button" class="btn btn-block btn-light float-right px-4" onClick="getOrder()">
                    {% if cart|length > 0 %}
                    <span class="fas fa-utensils"></span>
                    <span class="d-none d-md-inline"><strong>{% trans 'Order' %}:</strong></span>
                    <a>
                        <span class="d-none d-md-inline">{{ total_items }} {% trans 'Product'%}{{ total_items|pluralize }},</span>
                        <span class="d-sm-inline d-md-none">Total: </span>{% to_currency cart.get_total_price %}
                    </a>

                    {% else %}
                    <span class="fas fa-utensils"> {% trans 'Empty' %}</span>
                    {% endif %}
                </button>
            </div>
        </div>
        {% endwith %}
    </div>
    <script>
        function getOrder() {
            $('#modalOrder').modal('show');
            $.ajax({
                type: "get",
                url: "{% url 'cart:cart_detail' %}",
                success: function(data) {
                    let div = document.getElementById('modalBody');
                    div.innerHTML = data;
                }
            });
        };
        var csrftoken = Cookies.get('csrftoken');
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        function changeQty(command, id){
            let qtyInput = $("#qty"+id);
            let value = parseInt(qtyInput.val()) + command;
            if ( value < 0 )
                return true;
            qtyInput.val(value);
            let priceNum = $("#priceNum"+id);
            let priceU = parseInt(priceNum.text());
            let total = priceU * value
            $("#price"+id).text(convertToCurrency(total));
            getTotalAddsOn()
        }
        function getTotalAddsOn(){
            let addsTotal = 0;
              $('#addsOnForm').find('.totals').each(function(){
                addsTotal += localStringToNumber($(this).text());
              });
              let base = localStringToNumber($("#priceBase").text())
              grandTotal = addsTotal+ base;
              $("#grandTotal").val(grandTotal);
            $("#total").text(convertToCurrency(grandTotal))
        }
        function localStringToNumber( s ){
            let val = s.replace(/[.]/g,',');
            return Number(String(val).replace(/[^0-9.-]+/g,""));
        }
        function convertToCurrency(number){
            const options = {
                    maximumFractionDigits : 0,
                    minimumFractionDigits : 0,
                    currency              : "USD",
                    style                 : "currency",
                    currencyDisplay       : "symbol",
            }
            let usformat = number.toLocaleString(undefined, options);
            let val = usformat.replace(/[,]/g,'.');
            let currency = val.replace(/[US]/g,'');
            return currency
        }
    </script>

    {% block scripts %}
    {% endblock %}
    <footer>
        <div class="col-md-12 text-center bg-primary text-white ">
            <p>Made with love by My2Menu</p>
        </div>
    </footer>
</body>
</html>